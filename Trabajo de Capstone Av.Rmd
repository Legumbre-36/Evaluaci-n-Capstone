---
title: "Evaluación Capstone"
author: "Nicolás Marchant"
date: "2025-12-31"
output: html_document
---

Título: Determinantes sociales, cognitivos y conductuales del consumo del alcohol en la población chilena

1) Contexto:

A nivel internacional, el consumo de alcohol constituye un problema relevante de salud pública por su magnitud y por los costos sociales asociados. Se estima que el alcohol es responsable de 3,3 millones de muertes anuales en el mundo (5,9% de todas las defunciones) y se vincula causalmente con más de 200 enfermedades y trastornos, aportando además una fracción significativa de la carga global de morbilidad y lesiones (SENDA & Ministerio de Salud, 2016). En el caso de las Américas el consumo promedio es más alto que en otras regiones y, en los últimos años, se han reportado aumentos de episodios de consumo excesivo (OPS, 2015), lo que refuerza la pertinencia de analizar los determinantes que sostienen estos patrones.

En Chile, los determinantes del consumo de alcohol se articulan en torno a desigualdades sociodemográficas (edad/etapa del curso como aproximación al ciclo vital adolescente, género y condiciones socioeconómicas), además de factores de contexto como normas sociales, exposición a marketing y disponibilidad. La evidencia regional muestra que el daño asociado al alcohol se distribuye de manera inequitativa: grupos socioeconómicos más desfavorecidos tienden a experimentar mayores repercusiones sanitarias ante niveles comparables de consumo, y una fracción minoritaria de bebedores concentra una proporción desmesurada del volumen total consumido (OPS, 2015). 

Así como los determinantes sociodemográficos, existen factores vinculados a percepciones, conductas y salud mental que resultan relevantes para comprender el consumo de alcohol y sus impactos. La literatura sugiere que el consumo de alcohol rara vez aparece de forma aislada, especialmente durante la adolescencia, cuando tiende a integrarse en patrones de policonsumo. Por ejemplo, un estudio chileno con adolescentes escolarizados encontró que el inicio precoz del consumo de alcohol se asocia con una mayor probabilidad de consumo reciente de otras sustancias y con la presencia de otros comportamientos de riesgo, lo que es consistente con la noción de “constelaciones” de conductas interrelacionadas (Vilugrón et al., 2022). Asimismo, el mismo estudio reporta asociaciones entre el consumo y variables psicosociales como insatisfacción con la vida, insatisfacción escolar y bajo apoyo familiar.

Por otra parte, la percepción de riesgo opera como un determinante proximal relevante: cuando el consumo se evalúa como poco riesgoso, aumenta la probabilidad de iniciación y mantención, especialmente en contextos donde el alcohol se encuentra socialmente normalizado. En Chile, la medición en población escolar evidencia una marcada asimetría: el consumo ocasional presenta niveles bajos de percepción de “gran riesgo”, mientras que el consumo diario es evaluado como más peligroso por una proporción considerablemente mayor de estudiantes (SENDA, 2023).
No obstante, los antecedentes citados refieren principalmente a población escolar. En este trabajo, por tanto, se buscará operacionalizar las variables antes mencionadas y examinar su asociación con el consumo de alcohol en población general, con el fin de evaluar en qué medida estos factores mantienen su relevancia más allá del contexto adolescente/escolar.

2) Objetivo:

El objetivo del estudio es estimar el efecto de factores sociodemográficos, percepción de riesgo, policonsumo de sustancias y salud mental sobre la probabilidad de consumo de alcohol en los últimos 30 días en Chile.


3) Metodología

El presente estudio se enmarca en un enfoque cuantitativo, utilizando información secundaria proveniente del Estudio Nacional de Drogas en Población General 2024, elaborado por el Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol (SENDA), el cual proporciona datos representativos a nivel nacional sobre patrones de consumo y características individuales de la población.

El análisis de los datos se desarrollará utilizando herramientas y técnicas abordadas a lo largo del Diplomado en Data Science para Ciencias Sociales, incluyendo procesos de limpieza y preparación de datos, análisis descriptivo, exploración de relaciones entre variables y modelamiento estadístico. Este enfoque metodológico busca integrar el análisis estadístico con una comprensión sustantiva del fenómeno estudiado, aportando evidencia empírica que contribuya a la reflexión y toma de decisiones en el diseño de estrategias de prevención e intervención basadas en políticas públicas.

Las variables consideradas para el análisis se presentan a continuación:

Variable dependiente:
Consumo de alcohol en los últimos 30 días, construida a partir de las variables:
a) Ha consumido alcohol (OH_1)
b) Consumió alcohol los últimos 30 días (OH_4)


Variables independientes:

La inclusión de variables independientes se estructuró en función de cuatro líneas temáticas:

a) Sociodemográficos
Edad (EDAD)
Estado civil (DP_2)
Pertenencia a un pueblo originario (DP_4)
Adhiere a una religión (DP_5)
Género (DP_8)
Nivel de escolaridad (DP_12)
Trabajó la semana pasada (CO_1)
Cargo en el trabajo (CO_6)


b) Consumo de otras sustancias los últimos 30 días

Consumo de cigarrillos (ST_1/ST_4)
Consumo de marihuana (MAR_1/MAR_4)
Consumo de cocaína (COC_1/COC_4)
Consumo de pasta base (PB_1/PB_4)
Consumo de tusi (TUS_1/TUS_4)

c) Salud mental
Percepción de estado de salud general (ST_1)
Habitualidad de problemas de salud mental: ¿Sus preocupaciones le han hecho perder mucho sueño? (T_SG_1_B)
Habitualidad de problemas de salud mental: Y, ¿Se ha sentido constantemente agobiado/a o en tensión? (T_SG_1_E)
Habitualidad de problemas de salud mental: ¿Ha sentido que no puede superar sus dificultades? (T_SG_1_F)
Habitualidad de problemas de salud mental: ¿Se ha sentido poco feliz y deprimido/a? (T_SG_1_I)
Habitualidad de problemas de salud mental: ¿Ha perdido confianza en sí mismo/a? (T_SG_1_J)
Habitualidad de problemas de salud mental: ¿Ha pensado que usted es una persona que no vale para nada? (T_SG_1_K)


d) Percepción de riesgo
Toma tres o más tragos por ocasión (T_PR_1_2)
Toma cinco o más tragos diariamente (T_PR_1_3)


4) Carga de bases de datos

En esta sección se realizará la carga de la base de datos que se utilizará en el estudio, junto con la importación de las librerías necesarias para este proceso.

```{r}
# Librerias
library(dplyr)
library(rio)
library(skimr)
library(ggplot2)
library(tidyverse)
library(plotly)
library(scales)
library(forcats)

# Semilla para reproducibilidad

set.seed(123)

# En la carpeta del capstone descargar "Base Publica ENPG 2024 (Stata 16).dta"
# Cargar base de datos 

ENPG_2024 <- import("Base Publica ENPG 2024 (Stata 16).dta") 

```

5) Exploración, limpieza y transformación de los datos

En esta sección se explorará la base de datos importada y, posteriormente, se realizará su limpieza con el fin de construir un data frame que incluya únicamente las variables que serán utilizadas en el análisis.

A continuación, se recodificarán las variables que se incorporarán en los modelos, con el objetivo de favorecer la parsimonia en la interpretación, focalizar y organizar las variables de consumo, y asegurar que su codificación quede alineada con la información presentada en el capítulo de contexto.

```{r}
#Exploración de datos

str(ENPG_2024)
head(ENPG_2024)
summary(ENPG_2024)
glimpse(ENPG_2024)

# Limpieza y transformación

ENPG_filtrado <- ENPG_2024 %>% select(RESPONDENT_SERIAL, EDAD, SEXO, OH_1, OH_2, OH_4,
                                      DP_4, DP_5, 
                                      DP_8, DP_12, DP_16, 
                                      MAR_1, MAR_4, PB_1, 
                                      PB_4, COC_1, COC_4, 
                                      TUS_1, TUS_4, T_PR_1_2, T_PR_1_3, 
                                      ST_1, ST_2, ST_5, T_SG_1_B, T_SG_1_E, 
                                      T_SG_1_I, T_SG_1_J, T_SG_1_K, T_SG_1_F, 
                                      CO_1, CO_6, DP_2)


head(ENPG_filtrado)


#Creación variable de consumo de alcohol los últimos 30 días (dependiente)

#Esta variable se construirá como un índice a partir de las preguntas “¿Ha consumido alcohol alguna vez en la vida?” y 
#“¿Cuándo fue la última vez que consumió alcohol?”, delimitando el consumo al periodo de los últimos 30 días.

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    alcohol_30d = case_when(
    OH_1 == 2 ~ 0, #NO HA CONSUMIDO ALCOHOL
    OH_4 == 1 ~ 1, #HA CONSUMIDO ULTIMOS 30D
    OH_4 == 2 ~ 0,
    OH_4 == 3 ~ 0)
    )

ENPG_filtrado <- ENPG_filtrado %>% 
mutate (alcohol_30d =case_when(
alcohol_30d == 1 ~ "Sí",
alcohol_30d == 0 ~ "No",
TRUE ~ NA_character_
))

skim(ENPG_filtrado)

table(ENPG_filtrado$alcohol_30d)


```

```{r}

#Variables independientes ()

#En este apartado se realizarán las recodificaciones de las variables independientes.

##1. Folio
ENPG_filtrado <- ENPG_filtrado %>%
rename(Folio = RESPONDENT_SERIAL)

# Sociodemográficas

##a) Edad
ENPG_filtrado <- ENPG_filtrado%>%  
  mutate(edad_recod =case_when(
    EDAD %in% c(12:18)~ 1,
    EDAD %in% c(19:25)~ 2,
    EDAD %in% c(26:34)~ 3,
    EDAD %in% c(35:44)~ 4,
    EDAD %in% c(45:70)~ 5
  )          )

##b) Estado civil

ENPG_filtrado <- ENPG_filtrado %>% 
  rename(estado_civil = DP_2)

##c. Pertenencia a un grupo originario

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(pueblo_ind = case_when(
    DP_4 %in% 1:12 ~ "Indígena",
    DP_4 == 13 ~ "No indígena",
    TRUE ~ NA_character_
  ))


##d. Adhiere a una religión

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(religion = case_when(
    DP_5 %in% 1:11 ~ "Religión",
    DP_5 == 12 ~ "No religión",
    TRUE ~ NA_character_
  ))

##e) Género

ENPG_filtrado <- ENPG_filtrado %>%
  mutate(
    genero = case_when(
      SEXO == 1 ~ "Masculino",
      SEXO %in% c(2:6, 99) ~ "Otro género",
      TRUE ~ NA_character_
    ),
    genero = factor(genero),
    genero = relevel(genero, ref = "Otro género") 
  )


##f) Nivel de escolaridad

ENPG_filtrado <- ENPG_filtrado%>%  
  mutate(escolaridad =case_when(
    DP_12 %in% 1:4 ~ "Enseñanza básica o menos",
    DP_12 %in% 5:8 ~ "Enseñanza media",
    DP_12 %in% 9:13~ "Enseñanza superior o más",
    DP_12 %in% 88 ~ "No sabe"
  )          )


ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(educacion_med = case_when(
    DP_12 %in% 5:13 ~ "Tiene educación media o superior",
    DP_12 %in% c(1:4, 88) ~ "No tiene educación media o superior", 
    TRUE ~ NA_character_
  ))


# g) Trabajó la semana pasada/Cargo trabajo (renombrando variables)


ENPG_filtrado <- ENPG_filtrado %>% 
  rename(trabaja_o_no = CO_1, cargo_trabajo = CO_6)


##Consumo de otras sustancias (construcción de variables)


# a) Consumo de cigarrillos

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Consumo_cigarros = case_when(
      ST_2 == 2 ~ 0,
      ST_5 == 1 ~ 1, 
      ST_5 == 2 ~ 0,
      ST_5 == 3 ~ 0
    )
  )

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(Consumo_cigarros = case_when(
    Consumo_cigarros == 1 ~ "Sí",
    Consumo_cigarros == 0 ~ "No",
    TRUE ~ NA_character_
  ))


# b) Consumo de marihuana

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Consumo_mar = case_when(
    MAR_1 == 2 ~ 0, #NO HA CONSUMIDO MARIHUANA
    MAR_4 == 1 ~ 1, #HA CONSUMIDO ULTIMOS 30D
    MAR_4 == 2 ~ 0,
    MAR_4 == 3 ~ 0)
    )

ENPG_filtrado <- ENPG_filtrado %>% 
mutate (Consumo_mar =case_when(
Consumo_mar == 1 ~ "Sí",
Consumo_mar == 0 ~ "No",
TRUE ~ NA_character_
))

# b) Consumo de cocaína

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Consumo_coc = case_when(
    COC_1 == 2 ~ 0, #NO HA CONSUMIDO COCAINA
    COC_4 == 1 ~ 1, #HA CONSUMIDO ULTIMOS 30D
    COC_4 == 2 ~ 0,
    COC_4 == 3 ~ 0)
    )

ENPG_filtrado <- ENPG_filtrado %>% 
mutate (Consumo_coc =case_when(
Consumo_coc == 1 ~ "Sí",
Consumo_coc == 0 ~ "No",
TRUE ~ NA_character_
))

# c) Consumo de pasta base

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Consumo_pb = case_when(
    PB_1 == 2 ~ 0, #NO HA CONSUMIDO PASTA BASE
    PB_4 == 1 ~ 1, #HA CONSUMIDO ULTIMOS 30D
    PB_4 == 2 ~ 0,
    PB_4 == 3 ~ 0)
    )

ENPG_filtrado <- ENPG_filtrado %>% 
mutate (Consumo_pb =case_when(
Consumo_pb == 1 ~ "Sí",
Consumo_pb == 0 ~ "No",
TRUE ~ NA_character_
))


# b) Consumo de tusi

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Consumo_tus = case_when(
    TUS_1 == 2 ~ 0, #NO HA CONSUMIDO TUSI
    TUS_4 == 1 ~ 1, #HA CONSUMIDO ULTIMOS 30D
    TUS_4 == 2 ~ 0,
    TUS_4 == 3 ~ 0)
    )

ENPG_filtrado <- ENPG_filtrado %>% 
mutate (Consumo_tus =case_when(
Consumo_tus == 1 ~ "Sí",
Consumo_tus == 0 ~ "No",
TRUE ~ NA_character_
))


## Salud mental y general

# a) Salud General

ENPG_filtrado <- ENPG_filtrado %>% 
  rename(salud_general = ST_1) 


ENPG_filtrado <- ENPG_filtrado %>%  
  mutate(salud_general = case_when(
    salud_general == 88 ~ NA,
    salud_general == 99 ~ NA,
    TRUE ~ salud_general
  ))

# b) Salud Mental: 
ENPG_filtrado <- ENPG_filtrado %>% 
  rename(sm_sueno = T_SG_1_B, sm_agobiado = T_SG_1_E, 
         sm_frustracion = T_SG_1_F, sm_depresion = T_SG_1_I, 
         sm_confianza = T_SG_1_J, sm_valía_moral = T_SG_1_K)


## Percepción de riesgo

ENPG_filtrado <- ENPG_filtrado %>% 
rename (Riesgo_ocasion = T_PR_1_2,
Riesgo_diario = T_PR_1_3)

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    Riesgo_ocasion_rec = case_when(
      Riesgo_ocasion == 88 ~ NA_real_,
      TRUE ~ Riesgo_ocasion
    ),
    Riesgo_diario_rec = case_when(
      Riesgo_diario == 88 ~ NA_real_,
      TRUE ~ Riesgo_diario
    )
  )

```

6) Hipótesis de trabajo

a)  Existe una asociación significativa entre el género y el consumo de alcohol, siendo las personas de género masculino las que presentan una mayor probabilidad de consumo, respecto de los otros géneros de las personas encuestadas.

b)  Existe una asociación significativa entre el consumo de alcohol y el consumo de otras drogas, de manera que quienes reportan consumo de  sustancias psicoactivas, tienen mayor probabilidad de haber consumido alcohol los últimos 30 días.

c) Las personas que presentan mayor habitualidad en problemas de salud mental tienen mayor probabilidad de reportar consumo de alcohol los últimos 30 días.

d) Las personas que presentan una menor percepción de riesgo asociada al consumo de alcohol tienden a mayor probabilidad de consumo de alcohol, en comparación con aquellas que perciben un mayor riesgo.

e) En el modelo Random Forest, las variables asociadas a policonsumo, percepción de riesgo y salud mental concentrarán la mayor importancia predictiva, en comparación con las variables sociodemográficas por sí solas.


7) Análisis descriptivo

En primera instancia, se realizará un análisis descriptivo para caracterizar la distribución de las variables de interés y explorar su relación con el consumo de alcohol en los últimos 30 días, que corresponde a la variable principal del estudio. En particular, se examinará cómo se comportan las variables seleccionadas al comparar los grupos que reportan consumo reciente versus quienes no lo reportan.

Para las variables nominales, se analizará su distribución en función del consumo de alcohol mediante gráficos de barras apiladas, lo que permitirá visualizar diferencias en la composición de categorías entre ambos grupos. En el caso de las variables numéricas u ordinales, se estimarán correlaciones con el consumo de alcohol (según corresponda al nivel de medición) y, adicionalmente, se utilizarán gráficos de caja para describir la dispersión y las diferencias en la distribución de estas variables entre personas que consumieron alcohol en los últimos 30 días y quienes no, facilitando la identificación de patrones, asimetrías y posibles valores atípicos relevantes para el análisis posterior.


Consumo de alcohol según estado civil

```{r}


```


Consumo de alcohol según pertenencia a un pueblo originario

```{r}


```

Consumo de alcohol según adherencia a una religión

```{r}


```

Consumo de alcohol según género

```{r}


```


Distribución de escolaridad media según consumo de alcohol

```{r}


```


Trabajo según consumo de alcohol

```{r}



```

Cargo en el trabajo según consumo de alcohol

```{r}


# 1) Recodificación (solo para el gráfico)

```


Consumo de cigarrillos según consumo de alcohol

```{r}


```


Consumo de marihuana según consumo de alcohol

```{r}



```


Consumo de cocaína según consumo de alcohol

```{r}

```


Consumo de pasta base según consumo de alcohol

```{r}

```

Consumo de tusi según consumo de alcohol

```{r}

```

Salud general según consumo de alcohol

```{r}

```

Salud mental según consumo de alcohol

```{r}
# Media, Desviación Estandar y N° por grupo

descriptivos_sm_alcohol <- ENPG_filtrado %>% 
  select(alcohol_30d, starts_with("sm_")) %>% 
  pivot_longer(
    cols = starts_with("sm_"),
    names_to = "Variable",
    values_to = "Valor"
  ) %>% 
  group_by(alcohol_30d, Variable) %>% 
  summarise(
    N = sum(!is.na(Valor)),
    Media = mean(Valor, na.rm = TRUE),
    DE = sd(Valor, na.rm = TRUE),
    Mediana = median(Valor, na.rm = TRUE),
    .groups = "drop"
  )

descriptivos_sm_alcohol

#  Tabla comparativa

tabla_sm_alcohol <- descriptivos_sm_alcohol %>% 
  pivot_wider(
    names_from = alcohol_30d,
    values_from = c(Media, DE, N),
    names_glue = "{.value}_{alcohol_30d}"
  )

tabla_sm_alcohol

# Gráfico de medias de salud mental según consumo de alcohol

ENPG_filtrado %>% 
  select(alcohol_30d, starts_with("sm_")) %>% 
  pivot_longer(
    cols = starts_with("sm_"),
    names_to = "Variable",
    values_to = "Valor"
  ) %>% 
  filter(!is.na(alcohol_30d), !is.na(Valor)) %>% 
  group_by(alcohol_30d, Variable) %>% 
  summarise(
    Media = mean(Valor, na.rm = TRUE),
    SD = sd(Valor, na.rm = TRUE),
    N = n(),
    SE = SD / sqrt(N),
    .groups = "drop"
  ) %>% 
  ggplot(aes(x = Variable, y = Media, fill = alcohol_30d)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_errorbar(
    aes(ymin = Media - 1.96 * SE, ymax = Media + 1.96 * SE),
    position = position_dodge(width = 0.7),
    width = 0.2
  ) +
  coord_flip() +
  labs(
    title = "Salud mental según consumo de alcohol (últimos 30 días)",
    subtitle = "Media e intervalo de confianza 95%",
    x = "",
    y = "Media",
    fill = "Consumo de alcohol"
  ) +
  theme_minimal()
```




8) Análisis predictivo: Regresión Logística

La regresión logística es especialmente útil para estudiar fenómenos como el consumo de alcohol porque, en este caso, la variable dependiente es dicotómica: solo puede tomar dos valores (haber consumido o no alcohol en los últimos 30 días). Este tipo de modelo permite estimar la probabilidad de que ocurra una de esas dos situaciones a partir de una o más variables explicativas, las cuales pueden ser numéricas o categóricas.


```{r}
# Para modelo Logit
# 1. Preprocesamiento y transformación de variables

# En esta etapa se realiza la transformación de las variables
# a sus formatos adecuados para la estimación del modelo Logit.
# Las variables categóricas se convierten en factores, mientras
# que las variables continuas (edad e indicadores de salud mental)
# se mantienen como numéricas para capturar variaciones marginales.

ENPG_filtrado <- ENPG_filtrado %>% 
  mutate(
    genero = factor(genero),
    pueblo_ind = factor(pueblo_ind),
    religion = factor(religion),
    educacion_med = factor(educacion_med),
    Consumo_mar = factor(Consumo_mar),
    Consumo_coc = factor(Consumo_coc),
    Consumo_pb = factor(Consumo_pb),
    Consumo_tus = factor(Consumo_tus),
    Consumo_cigarros = factor(Consumo_cigarros),
    EDAD = as.numeric(EDAD),
    Riesgo_diario_rec = factor(Riesgo_diario_rec),
    Riesgo_ocasion_rec = factor(Riesgo_ocasion_rec),
    trabaja_o_no = factor(trabaja_o_no),
    cargo_trabajo = factor(cargo_trabajo),
    salud_general = factor(salud_general),
    estado_civil = factor(estado_civil),
    sm_sueno = as.numeric(sm_sueno),
    sm_agobiado = as.numeric(sm_agobiado),
    sm_depresion = as.numeric(sm_depresion),
    sm_confianza = as.numeric(sm_confianza),
    sm_valía_moral = as.numeric(sm_valía_moral),
    sm_frustracion = as.numeric(sm_frustracion)
    
  )

# 2. Construcción de la base analítica del modelo

# Se seleccionan exclusivamente las variables relevantes para
# el análisis y se eliminan las observaciones con valores perdidos.
# Esto asegura consistencia interna en la estimación del modelo.

base_logit <- ENPG_filtrado %>% 
  select(
    alcohol_30d,
    EDAD, genero, pueblo_ind, religion,
    educacion_med,
    Consumo_mar, Consumo_coc, Consumo_pb, Consumo_tus, Riesgo_diario_rec,
    Riesgo_ocasion_rec, sm_sueno, sm_confianza, sm_agobiado, sm_depresion, 
    sm_valía_moral, sm_frustracion, salud_general, estado_civil, 
    Consumo_cigarros, cargo_trabajo, trabaja_o_no
  ) %>% 
  na.omit()

# 3. Recodificación de la variable dependiente

# La variable dependiente (consumo de alcohol en los últimos 30 días)
# se recodifica en formato binario:
# 1 = ha consumido alcohol
# 0 = no ha consumido alcohol
# Esta transformación es necesaria para la estimación del modelo Logit.

base_logit <- base_logit %>% 
  mutate(
    alcohol_30d = ifelse(alcohol_30d == "Sí", 1,
                          ifelse(alcohol_30d == "No", 0, NA)), 
    EDAD = as.numeric(EDAD), Riesgo_diario_rec = as.numeric(Riesgo_diario_rec), 
    Riesgo_ocasion_rec = as.numeric(Riesgo_ocasion_rec)
  )

# 4. Especificación y estimación del modelo logit

# Se estima un modelo de regresión logística (familia binomial,
# enlace logit), incorporando variables sociodemográficas,
# consumo de otras sustancias, percepción de riesgo y salud mental.
# El modelo permite estimar la probabilidad de consumo de alcohol
# controlando por múltiples factores relevantes.

modelo_logit <- glm(
  alcohol_30d ~ EDAD + genero + pueblo_ind + religion +
    educacion_med +
    Consumo_mar + Consumo_coc + Consumo_pb + Consumo_tus +
    Riesgo_diario_rec + Riesgo_ocasion_rec + sm_sueno + sm_confianza + sm_agobiado 
  + sm_depresion + sm_valía_moral + sm_frustracion + salud_general + estado_civil + 
    Consumo_cigarros + cargo_trabajo + trabaja_o_no,
  data = base_logit,
  family = binomial(link = "logit"),
  na.action = na.exclude
)

# 5. Obtención e interpretación de Coeficientes

# Los coeficientes del modelo se transforman a odds ratios
# mediante su exponenciación. Valores mayores a 1 indican
# mayor probabilidad de consumo de alcohol, mientras que
# valores menores a 1 sugieren un efecto protector.

coeficientes <- exp(modelo_logit$coefficients) 
coeficientes

# 6. Resumen del modelo

# El resumen del modelo permite evaluar la significancia
# estadística de cada predictor, así como la dirección
# e intensidad de sus efectos.

summary(modelo_logit)

# 7. Verificación de la variable dependiente 

# Se inspecciona la distribución y estructura de la variable
# dependiente para confirmar su correcta codificación binaria
# antes de la interpretación de resultados.

table(base_logit$alcohol_30d, useNA = "ifany")
str(base_logit$alcohol_30d)

# Hacer curva Roc y el analisis de sensitividad (con la matriz de confusión) 

# 8. Desempeño del modelo: Curva ROC y AUC


# Se calcula la probabilidad predicha de consumo de alcohol
# a partir del modelo Logit. Estas probabilidades se utilizan
# para evaluar la capacidad discriminante del modelo.

prob_pred_logit <- predict(modelo_logit, type = "response")


# Curva ROC

# La curva ROC (Receiver Operating Characteristic) evalúa la
# capacidad del modelo para discriminar entre quienes consumen
# y no consumen alcohol, considerando distintos puntos de corte.

library(pROC)

roc_logit <- roc(
  response = base_logit$alcohol_30d,
  predictor = prob_pred_logit
)

# Gráfico de la curva ROC

plot(
  roc_logit,
  main = "Curva ROC – Modelo Logit (Consumo de alcohol 30 días)",
  col = "blue",
  lwd = 2
)

# Línea diagonal (clasificación aleatoria)

abline(a = 0, b = 1, lty = 2, col = "gray")

# Área bajo la curva (AUC)

auc_logit <- auc(roc_logit)
auc_logit

# 9. Matriz de confusión

# Se define un punto de corte estándar de 0.5 para clasificar
# las probabilidades predichas en consumo (1) o no consumo (0).

pred_clase <- ifelse(prob_pred_logit >= 0.5, 1, 0)

# Matriz de confusión

matriz_confusion <- table(
  Observado = base_logit$alcohol_30d,
  Predicho = pred_clase
)

matriz_confusion

# Métricas derivadas de la matriz de confusión


# Exactitud (accuracy)
accuracy <- sum(diag(matriz_confusion)) / sum(matriz_confusion)

# Sensibilidad (recall / tasa de verdaderos positivos)
sensibilidad <- matriz_confusion["1", "1"] /
  sum(matriz_confusion["1", ])

# Especificidad (tasa de verdaderos negativos)
especificidad <- matriz_confusion["0", "0"] /
  sum(matriz_confusion["0", ])

accuracy
sensibilidad
especificidad
```

a) Interpretación

El modelo de regresión logística, que evalúa el consumo de alcohol durante los últimos 30 días en función de distintas variables predictoras, permitió reconocer patrones relevantes entre los factores considerados. Entre los resultados más importantes, se destacan los siguientes:



9) Análisis predictivo: Random forest

Se emplea Random Forest porque es un método de aprendizaje automático supervisado que integra varios árboles de decisión para aumentar la exactitud y la consistencia de las predicciones. Resulta conveniente ya que disminuye el riesgo de sobreajuste, se desempeña bien con conjuntos de datos con numerosas variables y es resistente a la influencia de valores atípicos. Además, permite estimar qué tan relevantes son las distintas variables para explicar la predicción.


```{r}
##Random Forest

## Carga de datos

base_rf <- ENPG_filtrado

## preprocesamiento de datos
#Transformar datos a factor previo a su procesamiento como RF

#Variables Folio y Sexo no necesitan tranformación

## 1. Variables que NO se transforman
# Folio y EDAD se mantienen como numéricas / identificadores
str(base_rf$Folio)
str(base_rf$EDAD)

#Variables sociodemográficas categóricas

## Estado civil 

base_rf$estado_civil <- factor(base_rf$estado_civil,
                               levels =  c(1:6), 
                               labels = c("Soltero/a", "Casado/a", 
                                          "Divorciado/a", "Viudo/a", 
                                          "Anulado/a", "Conviviente civil"))

## Sexo (1 = Masculino, 2 = Femenino)
base_rf$SEXO <- factor(base_rf$SEXO,
                       levels = c(1, 2),
                       labels = c("Masculino", "Femenino"))

## Género
base_rf$genero <- factor(base_rf$genero)

## Pueblo indígena
base_rf$pueblo_ind <- factor(base_rf$pueblo_ind)


## Escolaridad (ordenable)
base_rf$educacion_med <- factor(base_rf$educacion_med,
                              ordered = TRUE)
## Religion

base_rf$religion <- factor(base_rf$religion) 
                           

#Variables de consumo

base_rf$Consumo_mar <- factor(base_rf$Consumo_mar,
                              levels = c("No", "Sí"))

base_rf$Consumo_coc <- factor(base_rf$Consumo_coc,
                              levels = c("No", "Sí"))

base_rf$Consumo_cigarros <- factor(base_rf$Consumo_cigarros, 
                                   levels = c("No", "Sí"))

base_rf$Consumo_pb <- factor(base_rf$Consumo_pb,
                             levels = c("No", "Sí"))

base_rf$Consumo_tus <- factor(base_rf$Consumo_tus, 
                              levels = c("No", "Sí"))



##variables de riesgo con factor ordenado

base_rf$Riesgo_ocasion <- factor(base_rf$Riesgo_ocasion,
                                 ordered = TRUE)

base_rf$Riesgo_diario <- factor(base_rf$Riesgo_diario,
                                ordered = TRUE)

##Edad por tramos

base_rf$edad_recod <- factor(base_rf$edad_recod,
                             ordered = TRUE)

# Salud 
base_rf$salud_general <- factor(base_rf$salud_general, 
                                ordered = TRUE)

base_rf$sm_agobiado <- factor(base_rf$sm_agobiado, 
                              ordered = TRUE)

base_rf$sm_confianza <- factor(base_rf$sm_confianza, 
                               ordered = T)

base_rf$sm_depresion <- factor(base_rf$sm_depresion, 
                               ordered = T)

base_rf$sm_frustracion <- factor(base_rf$sm_frustracion, 
                                 ordered = T)

base_rf$sm_sueno <- factor(base_rf$sm_sueno, 
                           ordered = T)

base_rf$sm_valía_moral <- factor(base_rf$sm_valía_moral, 
                                 ordered = T)

# Trabajo 

base_rf$trabaja_o_no <- factor(base_rf$trabaja_o_no, 
                               levels = c(1,2),
                               labels = c("Sí", "No"))

base_rf$cargo_trabajo <- as.numeric(base_rf$cargo_trabajo)


##Revisión de base pre procesada

str(base_rf)
summary(base_rf)


##Selección de variables como predictoras del consumo, usaremos las variables sociodemográficas en esta elección, toda vez que pretendemos conocer las características sociales y demográficas asociadas a la ingesta de alcohol

vars_pred <- c(
  "EDAD",
  "estado_civil",
  "SEXO",
  "genero",
  "pueblo_ind",
  "educacion_med",
  "religion",
  "Consumo_mar",
  "Consumo_coc",
  "Consumo_cigarros",
  "Consumo_pb",
  "Consumo_tus",
  "Riesgo_ocasion",
  "Riesgo_diario",
  "edad_recod",
  "salud_general",
  "sm_agobiado",
  "sm_confianza",
  "sm_depresion",
  "sm_frustracion",
  "sm_valía_moral",
  "trabaja_o_no",
  "cargo_trabajo"
)




## Instalar y cargar paquetes
if(!require(randomForest)) install.packages("randomForest")
if(!require(caret)) install.packages("caret")

library(randomForest)
library(caret)

# Seleccin de columnas
rf_data <- base_rf[, c("alcohol_30d", vars_pred)]

rf_data <- na.omit(rf_data)
# Imputamos valores faltantes

##Para variables categóricas: reemplazamos NA por la categoría más frecuente
for(col in vars_pred){
  if(is.factor(rf_data[[col]])){
    most_common <- levels(rf_data[[col]])[which.max(table(rf_data[[col]]))]
    rf_data[[col]][is.na(rf_data[[col]])] <- most_common
  }
}

## Para variables numéricas: reemplaza NA por la mediana
for(col in vars_pred){
  if(is.numeric(rf_data[[col]])){
    rf_data[[col]][is.na(rf_data[[col]])] <- median(rf_data[[col]], na.rm = TRUE)
  }
}

# Revisión de presencia de NA
sapply(rf_data, function(x) sum(is.na(x)))

# Convertir alcohol_30d en factor
rf_data$alcohol_30d <- factor(rf_data$alcohol_30d, levels = c("No", "Sí"))


# División de datos de entrenamiento y prueba
set.seed(123)
trainIndex <- createDataPartition(rf_data$alcohol_30d, p = 0.7, list = FALSE)

trainData <- rf_data[trainIndex, ]
testData  <- rf_data[-trainIndex, ]

# Construir la fórmula desde vars_pred (variables independientes)
formula_rf <- as.formula(
  paste("alcohol_30d ~", paste(vars_pred, collapse = " + "))
)

# Ajuste del modelo Random Forest
set.seed(123)
rf_model <- randomForest(
  formula_rf,
  data = trainData,
  ntree = 500,
  mtry = floor(sqrt(length(vars_pred))),
  importance = TRUE
)


# Revisar el modelo entrenado
print(rf_model)

#De los resultados obtenidos, se aprecia un error rate de 28.81%, lo que implica que en el 71.19% de las veces
#el modelo predice correctamente el consumo de alcohol en el conjunto de entrenamiento
#Con respecto a la matriz de confusión, el modelo exhibe problemas para predecir los no consumidores, toda vez que presenta un error del 84%;sin embargo, en la predicción de los consumidores de alcohol funciona de mejor forma, con un error del 2.47% aprox. En resumen, el modelo fue capaz de predecir correctamente 8625 casos de consumidores y 664 casos de no consumidores. No obstante, clasificó de forma errónea 3541 casos de no consumidores y 219 casos de consumidores, concluyendo que el modelo resulta más preciso en la identificación de factores asociados al consumo, pero evidencia dificultades en la detección de quienes no consumirán alcohol.


## Predicciones en conjunto de prueba
pred_test <- predict(rf_model, newdata = testData)

# Evaluación del desempeño
confusionMatrix(pred_test, testData$alcohol_30d, positive = "Sí")


#En complemento a lo señalado precentemente, el modelo en la precisión global acierta en aprox. el 71% de las veces
#Presenta una sensivity del 15%, toda vez que la predicción de los no consumidores no es buena
#Presenta una specifity del 97%, en tanto el modelo predice muy bien a los consumidores



#Importancia de variables 
varImpPlot(rf_model)
importance(rf_model)

#los resultados dan cuenta que, de las variables seleccionadas, las de mayor relevancia para predecir el consumo, estan asociadas a la Edad y el nivel de escolaridad, seguida por sexo y pueblo originario, en el caso de consumidores también adquiere relevancia la pertenencia indígena y se estima que las variables relgión e ingresos no son determinantes en la población objeto de estudio.

#Curva de ROC

# Cargar paquete y librería
if(!require(pROC)) install.packages("pROC")

library(pROC)


# Obtener probabilidades en lugar de clases
pred_probs <- predict(rf_model, testData, type = "prob")

head(pred_probs)


#para la curva de ROC usaremos la probabilidad de clase positiva (si)

prob_si <- pred_probs[, "Sí"]

# Calcular curva ROC
roc_curve <- roc(testData$alcohol_30d, prob_si, levels = c("No", "Sí"), direction = "<")

# Dibujar la curva
plot(roc_curve, main="Curva ROC - Random Forest", col="blue", lwd=2)

coords(roc_curve, treshold = "best")

# Calcular el Área Bajo la Curva (AUC)
auc_value <- auc(roc_curve)
print(paste("Área bajo la curva (AUC):", round(auc_value, 3)))

```

10) Conclusiones



Referencias 
•	Organización Panamericana de la Salud. (2015). Situación regional del consumo de alcohol y la salud en las Américas: Resumen del informe [Hoja informativa]. OPS. Organización Panamericana de la Salud

•	Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol. (2023). Décimo Cuarto Estudio Nacional de Drogas en Población Escolar de Chile 2021: 8º básico a 4º medio. Observatorio Chileno de Drogas, Ministerio del Interior y Seguridad Pública, Gobierno de Chile. SENDA

•	Servicio Nacional para la Prevención y Rehabilitación del Consumo de Drogas y Alcohol (SENDA) & Ministerio de Salud (MINSAL). (2016). El consumo de alcohol en Chile: Situación epidemiológica. https://www.senda.gob.cl/wp-content/uploads/media/estudios/otrosSENDA/2016_Consumo_Alcohol_Chile.pdf

•	Vilugrón, F., Molina, T., Gras Pérez, M. E., & Font-Mayolas, S. (2022). Precocidad de inicio del consumo de sustancias psicoactivas y su relación con otros comportamientos de riesgo para la salud en adolescentes chilenos. Revista Médica de Chile, 150, 584–596. Revista Médica de Chile





